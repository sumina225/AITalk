pipeline {
    agent any

    environment {
        IMAGE_NAME = "suhwany/aitalk"  // âœ… í•˜ë‚˜ì˜ Docker Hub ë ˆí¬ì§€í† ë¦¬
        IMAGE_TAG_BACKEND = "backend-latest"  // ë°±ì—”ë“œ íƒœê·¸
        IMAGE_TAG_FRONTEND = "frontend-latest"  // í”„ë¡ íŠ¸ì—”ë“œ íƒœê·¸

        MATTERMOST_WEBHOOK = "https://meeting.ssafy.com/hooks/9p1665jgnjdn3msh9piyg1zpme"  // âœ… Mattermost ì›¹í›… URL
    }

    stages {
        stage('Notify GitLab') {
            steps {
                echo 'Notify GitLab'
                updateGitlabCommitStatus name: 'build', state: 'pending'
            }
        }

        stage('Checkout') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'gitlabId', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_TOKEN')]) {
                        git branch: 'develop', url: "https://${GIT_USERNAME}:${GIT_TOKEN}@lab.ssafy.com/s12-webmobile3-sub1/S12P11E102.git"
                    }
                }
            }
        }

        stage('Build Backend') {
            steps {
                sh '''
                cd Be/AITalk
                chmod +x ./gradlew
                ./gradlew clean build -x test "-Dorg.gradle.jvmargs=-Xmx2g"
                '''
            }
        }

        stage('Docker Build & Push Backend') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'DockerId', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                        cd Be/AITalk
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG_BACKEND} .
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${IMAGE_NAME}:${IMAGE_TAG_BACKEND}
                        '''
                    }
                }
            }
        }

        stage('Build Frontend') {
            steps {
                sh '''
                cd Fe/admin-project
                rm -rf node_modules package-lock.json dist
                npm install
                chmod +x node_modules/.bin/tsc  # TypeScript ì‹¤í–‰ ê¶Œí•œ ì¶”ê°€
                npm run build
                '''
            }
        }

        stage('Docker Build & Push Frontend') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'DockerId', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                        cd Fe/admin-project

                        # âœ… Vite ë¹Œë“œ í›„ dist í´ë”ë¥¼ Nginx ì»¨í…Œì´ë„ˆì— í¬í•¨
                        docker build -t ${IMAGE_NAME}:${IMAGE_TAG_FRONTEND} .

                        # âœ… Docker Hub ë¡œê·¸ì¸ í›„ í‘¸ì‹œ
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${IMAGE_NAME}:${IMAGE_TAG_FRONTEND}
                        '''
                    }
                }
            }
        }


        stage('Deploy to EC2 (Backend)') {
            steps {
                sh '''
                chmod +x jenkins/scripts/deploy_backend.sh
                ./jenkins/scripts/deploy_backend.sh
                '''
            }
        }

        stage('Deploy to EC2 (Frontend)') {
            steps {
                sh '''
                chmod +x jenkins/scripts/deploy_frontend.sh
                ./jenkins/scripts/deploy_frontend.sh
                '''
            }
        }
    }

    post {
        success {
            script {
                sh '''
                curl -X POST -H 'Content-Type: application/json' --data '{
                    "text": "âœ… Jenkins Build & Deployment Success! ğŸ‰"
                }' ${MATTERMOST_WEBHOOK}
                '''
            }
            updateGitlabCommitStatus name: 'build', state: 'success'
        }
        failure {
            script {
                sh '''
                curl -X POST -H 'Content-Type: application/json' --data '{
                    "text": "âŒ Jenkins Build Failed! ğŸ”¥"
                }' ${MATTERMOST_WEBHOOK}
                '''
            }
            updateGitlabCommitStatus name: 'build', state: 'failed'
        }
    }
}
